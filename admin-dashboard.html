// --- Start of Corrected Dashboard Script ---
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script type="module">
    // Authentication Check (Keep this at the top)
    if (sessionStorage.getItem("loggedIn") !== "true") {
      window.location.href = "admin-login.html";
    }

    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-app.js";
    import { getDatabase, ref, get, remove } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBKZO_8CgrQfm7eBGcR9h8D6JxWY4MBaQ",
      authDomain: "hindi-english-dictation.firebaseapp.com",
      databaseURL: "https://hindi-english-dictation-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "hindi-english-dictation",
      storageBucket: "hindi-english-dictation.appspot.com",
      messagingSenderId: "186334580803",
      appId: "1:186334580803:web:7dfdf806d9da19a4cc4f6",
      measurementId: "G-7LH1856B2W"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    // Logout
    window.logout = function () {
      sessionStorage.removeItem("loggedIn");
      window.location.href = "admin-login.html";
    }

    // Load Total Visitors
    get(ref(db, 'visitCount')).then(snapshot => {
      document.getElementById('visitCount').innerText = snapshot.exists() ? snapshot.val() : "0";
    }).catch(error => {
      console.error("Firebase Error (Total Visits):", error);
      document.getElementById('visitCount').innerText = "DATA ERROR";
    });

    // Load Daily Visits and Calculate 7/30 Day Totals (and Chart)
    get(ref(db, 'visits_by_day')).then(snapshot => {
      const weeklyCountEl = document.getElementById('weeklyCount');
      const monthlyCountEl = document.getElementById('monthlyCount');
        
      if (snapshot.exists()) {
        const data = snapshot.val();
        const today = new Date();
        let labels = [], values = [], weeklySum = 0, monthlySum = 0;

        for (let i = 29; i >= 0; i--) {
          const date = new Date(today);
          date.setDate(today.getDate() - i);
          const key = date.toISOString().slice(0, 10);
          const count = data[key] || 0;
          labels.push(key);
          values.push(count);
          if (i < 7) weeklySum += count;
          monthlySum += count;
        }

        weeklyCountEl.innerText = weeklySum;
        monthlyCountEl.innerText = monthlySum;

        const ctx = document.getElementById("dailyChart").getContext("2d");
        new Chart(ctx, {
          type: 'bar',
          data: {
            labels: labels,
            datasets: [{ label: "Visits", data: values, backgroundColor: "#3498db" }]
          },
          options: {
            responsive: true,
            plugins: { legend: { display: false } },
            scales: {
              x: { ticks: { maxRotation: 90, minRotation: 45 } },
              y: { beginAtZero: true, suggestedMax: Math.max(...values) + 5 } // Improve Y-axis scaling
            }
          }
        });
      } else {
        weeklyCountEl.innerText = "0";
        monthlyCountEl.innerText = "0";
      }
    }).catch(error => {
      console.error("Firebase Error (Daily Visits):", error);
      document.getElementById('weeklyCount').innerText = "DATA ERROR";
      document.getElementById('monthlyCount').innerText = "DATA ERROR";
    });

    // Load Ad Earnings (and Chart)
    get(ref(db, 'ads_earnings')).then(snapshot => {
      if (snapshot.exists()) {
        const earnings = snapshot.val();
        const today = new Date();
        let labels = [], values = [];

        for (let i = 29; i >= 0; i--) {
          const date = new Date(today);
          date.setDate(today.getDate() - i);
          const key = date.toISOString().slice(0, 10);
          labels.push(key);
          values.push(earnings[key] || 0);
        }

        const ctx = document.getElementById("adsChart").getContext("2d");
        new Chart(ctx, {
          type: 'line',
          data: {
            labels: labels,
            datasets: [{
              label: "₹ Earnings",
              data: values,
              borderColor: "#2ecc71",
              backgroundColor: "rgba(46, 204, 113, 0.1)",
              fill: true
            }]
          },
          options: {
            responsive: true,
            scales: { y: { beginAtZero: true } }
          }
        });
      }
    }).catch(error => {
      console.error("Firebase Error (Ad Earnings):", error);
    });

    // Load Feedbacks (Kept your existing robust logic)
    const feedbackRef = ref(db, 'feedbacks');
    get(feedbackRef).then(snapshot => {
      // ... (your existing feedback rendering logic here)
      const listDiv = document.getElementById('feedbackList');
      if (snapshot.exists()) {
        const feedbacks = snapshot.val();
        let allFeedback = '';

        Object.entries(feedbacks).reverse().forEach(([key, entry]) => {
          const date = new Date(entry.timestamp).toLocaleString('en-IN');
          allFeedback += `
            <div style="margin-bottom: 15px; padding: 10px; border-bottom: 1px solid #ddd;">
              <strong>•</strong> ${entry.text}<br>
              <small style="color: gray;">${date}</small><br>
              <button onclick="deleteFeedback('${key}')" style="margin-top: 5px; background: #e74c3c; color: white; border: none; padding: 5px 10px; border-radius: 5px;">Delete</button>
            </div>`;
        });

        listDiv.innerHTML = allFeedback;
      } else {
        listDiv.innerText = "No feedbacks yet.";
      }
    }).catch(() => {
      document.getElementById('feedbackList').innerText = "Error loading feedbacks.";
    });

    // Delete Feedback (Needs to be a global function)
    window.deleteFeedback = function (key) {
      const confirmDelete = confirm("Are you sure you want to delete this feedback?");
      if (!confirmDelete) return;
      remove(ref(db, 'feedbacks/' + key)).then(() => {
        alert("Deleted!");
        location.reload();
      }).catch((error) => {
        console.error("Delete Error:", error);
        alert("Failed to delete. Check console for error details.");
      });
    }
</script>
---

## 2. Fixing the Feedback Visibility Issue

You mentioned: **"there is also error when anyone give feedback I can't able to view in my dashboard."**

This is almost certainly a **Firebase Security Rule issue** related to authentication and permissions.

### A. The Cause: Read Access is Blocked

Your feedback submission works from the public site because you likely set the `.write` rule to `true`. However, your dashboard requires the ability to **read** and **delete** this data.

If you are not properly *authenticated* as the Admin User when you load the dashboard, Firebase blocks the read access, resulting in the "Error loading feedbacks" message.

### B. The Solution: Check Authentication and Rules

You must ensure two things are true:

1.  **Authentication:** Your `admin-login.html` successfully signs you in using Firebase Authentication (e.g., `signInWithEmailAndPassword`) **before** it redirects you to the dashboard. Simply setting `sessionStorage.setItem("loggedIn", "true")` is **not enough** to authenticate you with Firebase.
2.  **Security Rule:** Your Firebase Realtime Database Rule for the `feedbacks` node must look exactly like this (using your actual Admin User ID):

```json
"feedbacks": {
  // Allows anyone to write (submit feedback)
  ".write": true,
  // ONLY allows the authenticated admin user to read/delete
  ".read": "auth != null && auth.uid === 'YOUR_ADMIN_UID'",
  "$feedbackId": {
    ".write": "auth != null && auth.uid === 'YOUR_ADMIN_UID'"
  }
}
